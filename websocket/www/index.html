<!DOCTYPE html>
<html>

<head>
    <!-- Foundation CSS framework (Bootstrap and jQueryUI also supported) -->
    <link rel='stylesheet' href='css/foundation.min.css'>
    <!-- Font Awesome icons (Bootstrap, Foundation, and jQueryUI also supported) -->
    <link rel='stylesheet' href='css/font-awesome.min.css'>
    <style>
    [class*="foundicon-"] {
        font-family: GeneralFoundicons;
        font-style: normal;
    }
    .drop-define {
        border: 5px dashed transparent;
    }
    .active {
        opacity: 0.8;
        background-color: #cbe9ef;
        border: 5px dashed #9c9c9c;
    }
    </style>
    <script src="jsoneditor.js"></script>
    <!-- Please copy the following files into here: -->
    <script src="./Long.min.js"></script>
    <!-- https://raw.github.com/dcodeIO/Long.js/master/dist/Long.min.js -->
    <script src="./ByteBufferAB.min.js"></script>
    <!-- https://raw.github.com/dcodeIO/ByteBuffer.js/master/dist/ByteBufferAB.min.js -->
    <script src="./ProtoBuf.js"></script>
    <!-- https://raw.github.com/dcodeIO/ProtoBuf.js/master/dist/ProtoBuf.min.js -->
    <script src="./jquery-1.12.0.min.js"></script>
</head>

<body>
    <div class='container'>
        <div class='row'>
            <div id="dropdef" class='span8 col-md-8 columns eight large-8 drop-define'>
                <h2>编辑器</h2>
                <p>选择PB定义文件或者直接拖放到这里</p>
                <div class="row-fluid">
                    <input id="readdef" type="file" class="button tiny" style="width: auto;"/>
                    <select id="pb-sel" style="width: auto; display: none;">
                    </select>
                    <!-- <button id="pb-create" class="tiny">创建</button> -->
                </div>
                <div id='editor'></div>
            </div>
            <div id="dropdata" class='span4 col-md-4 columns four large-4 drop-define'>
                <h2>JSON输出</h2>
                <p>选择PB数据文件或者直接拖放到这里
                    
                </p>
                <input id="readdata" type="file" class="button tiny"  style="width: auto;"/>
                <button class='btn btn-primary tiny' id='setvalue'>更新到编辑器</button>
                <textarea id='output' style='width: 100%; height: 300px; font-family: monospace;' class='form-control'></textarea>
                <h2>Validation</h2>
                <p>This will update whenever the form changes to show validation errors if there are any.</p>
                <textarea id='validate' style='width: 100%; height: 100px; font-family: monospace;' readonly disabled class='form-control'></textarea>
            </div>
        </div>
    </div>
    <script>
    if (typeof dcodeIO === 'undefined' || !dcodeIO.ProtoBuf) {
        throw (new Error("ProtoBuf.js is not present. Please see www/index.html for manual setup instructions."));
    }
    // Initialize ProtoBuf.js
    var ProtoBuf = dcodeIO.ProtoBuf;
    var builder;
    var Message;
    
    function readDefineFile(file) {
        if (!(file instanceof File)) {
            return
        }
        var reader = new FileReader();
        reader.onload = function(e) {
            var result = e.target.result;
            builder = ProtoBuf.loadProto(result);
            var pbSel = $("#pb-sel");
            pbSel.empty();
            $(builder.ns.children).each(function(k, v) {
                var option = $("<option>");
                option.attr("value", k);
                option.html(v.name);
                pbSel.append(option);
                pbSel.show();
                pbSel.trigger("change");
            });
        };
        reader.onerror = function(e) {
            console.log("err", e);
        };
        reader.readAsText(file);
    };

    $("#readdef").on("change", function(evt) {
        var files = evt.target.files[0];
        if(files.length == 0){ 
            return false; 
        }
        readDefineFile(files[0]);        
    });

    function registerDropArea(ele, callback) {
        ele.on({
            dragleave:function(e){
                e.preventDefault();
                ele.removeClass("active");
            }, 
            drop:function(e){
                e.preventDefault(); 
                var files = e.originalEvent.dataTransfer.files;
                if(files.length == 0){ 
                    return false; 
                }
                callback(files[0]);
                ele.removeClass("active");
            },
            dragenter:function(e){
                e.preventDefault();
            }, 
            dragover:function(e){
                e.preventDefault(); 
                ele.addClass("active");
            }
        });
    }

    registerDropArea($("#dropdef"), function(result) {
        readDefineFile(result); 
    });

    $("#pb-sel").on("change", function(evt) {
        var pbIndex = $("#pb-sel").val();
        Message = builder.ns.children[pbIndex];

        function convertField(field) {
            var mappings = {
                'message': 'object',
                'int32': 'integer',
                'double': 'number',
                'string': 'string',
                'bool': 'boolean'
            };
            var type = mappings[field.type.name] || field.type.name;
            var schema
            if (type === "object") {
                schema = convertMessage(field.resolvedType);
            } else {
                schema = {};
                schema.type = type;
                schema.id = field.id;
                if (field.defaultValue) {
                    schema.defaultValue = field.defaultValue;
                }
            }
            if (field.repeated) {
                return {
                    type: "array",
                    items: schema
                }
            } else {
                return schema;
            }
        }

        function convertMessage(message) {
            var obj = {};
            obj.title = message.name;
            obj.type = "object";
            obj.properties = {};
            $(message.children).each(function(k, v) {
                obj.properties[v.name] = convertField(v);
            });
            return obj;
        }
        schema = convertMessage(Message);
        var output = JSON.stringify(schema, null, 4);
        console.dir(schema);
        console.log(output);
        reload();
    });
    
    var schema;
    var jsoneditor;
    var editor = $("#editor")[0];
    var output = $("#output");
    var validate = $("#validate");
    var reload = function(keep_value) {
        var startval = (jsoneditor && keep_value)? jsoneditor.getValue() : window.startval;
        window.startval = undefined;

        if(jsoneditor) jsoneditor.destroy();
        jsoneditor = new JSONEditor(editor,{
            schema: schema || {},
            startval: startval
        });
        window.jsoneditor = jsoneditor;

        // When the value of the editor changes, update the JSON output and validation message
        jsoneditor.on("change",function() {
            var json = jsoneditor.getValue();

            output.val(JSON.stringify(json,null,2));

            var validation_errors = jsoneditor.validate();
            // Show validation errors if there are any
            if(validation_errors.length) {
                validate.val(JSON.stringify(validation_errors,null,2));
            }
            else {
                validate.val('valid');
            }
        });
    };
    $("#setvalue").on('click',function() {
        jsoneditor.setValue(JSON.parse(output.val()));
    });
    JSONEditor.defaults.options.object_layout = 'normal';
    JSONEditor.defaults.options.show_errors = 'interaction';
    JSONEditor.defaults.options.theme = 'foundation5';
    JSONEditor.defaults.options.iconlib = 'fontawesome4';

    function readDataFile(file) {
        if (!(file instanceof File)) {
            return
        }
        var reader = new FileReader();
        reader.onload = function(e) {
            var result = e.target.result;
            var msg = builder.build(Message.name).decode(result);
            var jsonString = JSON.stringify(msg, null, 4);
            output.val(jsonString);
            console.log(msg);
        };
        reader.onerror = function(e) {
            console.log("err", e);
        };
        reader.readAsArrayBuffer(file);
    };

    registerDropArea($("#dropdata"), function(result) {
        readDataFile(result); 
    });

    $("#readdata").on("change", function(evt) {
        var files = evt.target.files[0];
        if(files.length == 0){ 
            return false; 
        }
        readDataFile(files[0]);        
    });
    
    </script>
    <!--
<textarea id="log" style="width: 100%; height: 200px"></textarea><br />
<input type="text" id="text" value="hello world!" /> <button onclick="send()">Send</button>

<script>
var log = document.getElementById("log");
var text = document.getElementById("text");

// Connect to our server: node server.js
var socket = new WebSocket("ws://localhost:8080/ws");
socket.binaryType = "arraybuffer"; // We are talking binary

function send() {
    if (socket.readyState == WebSocket.OPEN) {
        var msg = new Message();
        msg.cityId = text.value;
        socket.send(msg.toArrayBuffer());
        log.value += "Sent: "+msg.cityId+"\n";
    } else {
        log.value += "Not connected\n";
    }
}

socket.onopen = function() {
    log.value += "Connected\n";
};

socket.onclose = function() {
    log.value += "Disconnected\n";
};
    
socket.onmessage = function(evt) {
    try {
        // Decode the Message
        var msg = Message.decode(evt.data);
        console.dir(msg)
        log.value += "Received: "+msg.cityId+"\n";
    } catch (err) {
        log.value += "Error: "+err+"\n";
    }
};

log.value = ""; // Clear log on reload
</script>
-->
</body>

</html>